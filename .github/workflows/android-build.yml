name: Android build

on:
  push:
    branches: [ main, master ]
  name: Android build

  on:
    push:
      branches: [ main, master ]
    workflow_dispatch: {}

  jobs:
    build:
      runs-on: ubuntu-latest
      env:
        ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
        ANDROID_HOME: ${{ runner.temp }}/android-sdk
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '18'

        - name: Prepare web assets and (optional) npm/capacitor
          run: |
            if [ -f package.json ]; then
              echo "package.json found — installing deps and running npx cap sync"
              if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
                npm ci
              else
                npm install --no-audit --no-fund
              fi
              npx cap sync android
            else
              echo "package.json not found — skipping npm install and cap sync"
            fi

        - name: Copy web assets into Android assets
          run: |
            echo "Copying web assets to android assets"
            mkdir -p android/app/src/main/assets/public
            rm -rf android/app/src/main/assets/public/*
            cp -a www/. android/app/src/main/assets/public/

        - name: Set up Java 17
          uses: actions/setup-java@v4
          with:
            distribution: temurin
            java-version: '17'

        - name: Install Android SDK command-line tools and platforms
          run: |
            mkdir -p "$ANDROID_SDK_ROOT"
            echo "Downloading Android command line tools"
            curl -fSL "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o cmdline-tools.zip
            unzip -q cmdline-tools.zip -d "$HOME"
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
            mv "$HOME/cmdline-tools"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/" || true
            rm -f cmdline-tools.zip
            export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
            yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses || true
            sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;33.0.2"
          shell: bash

        - name: Make gradlew executable and show versions
          working-directory: android
          run: |
            chmod +x ./gradlew || true
            java -version || true
            ./gradlew --version || true

        - name: Build Android APK (capture log)
          working-directory: android
          env:
            GRADLE_USER_HOME: ${{ runner.temp }}/.gradle
            ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
            ANDROID_HOME: ${{ runner.temp }}/android-sdk
          run: |
            ./gradlew assembleDebug --no-daemon --stacktrace --info 2>&1 | tee gradle-output.log || true

        - name: Upload Gradle log
          uses: actions/upload-artifact@v4
          with:
            name: gradle-log
            path: android/gradle-output.log

        - name: Upload APK artifact
          uses: actions/upload-artifact@v4
          with:
            name: app-debug-apk
            path: android/app/build/outputs/apk/debug/app-debug.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
